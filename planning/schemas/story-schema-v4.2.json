{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "wave-v2-story-schema-v4.2",
  "title": "Wave V2 Story Schema V4.2",
  "description": "Hybrid AI Story Schema merging V4 practical TDD excellence with V4.1 formal requirements. Backward compatible with V4 stories.",
  "type": "object",
  "required": [
    "story_id",
    "title",
    "domain",
    "wave_number",
    "priority",
    "status",
    "objective",
    "acceptance_criteria",
    "files",
    "safety"
  ],
  "properties": {
    "$schema": {
      "type": "string",
      "description": "Reference to this schema file"
    },
    "schema_version": {
      "type": "string",
      "const": "4.2",
      "description": "Schema version identifier"
    },

    "story_id": {
      "type": "string",
      "pattern": "^[A-Z]+-[A-Z0-9]+-?[0-9]*$",
      "description": "Story identifier. Supports: WAVE1-FE-001, BE-03, UI-04A, UI-05B",
      "examples": ["WAVE1-FE-001", "BE-03", "UI-04A", "UI-05B"]
    },
    "title": {
      "type": "string",
      "minLength": 5,
      "maxLength": 100,
      "description": "Concise, descriptive story title"
    },
    "type": {
      "type": "string",
      "enum": ["feature", "enhancement", "bugfix", "refactor", "test", "documentation", "security", "infrastructure"],
      "default": "feature",
      "description": "Story type classification"
    },
    "domain": {
      "type": "string",
      "enum": ["frontend", "backend", "fullstack", "security", "integration", "qa", "infrastructure", "design"],
      "description": "Technical domain ownership"
    },
    "agent": {
      "type": "string",
      "enum": ["fe-dev", "be-dev", "qa", "pm", "cto", "security"],
      "description": "Assigned implementation agent"
    },
    "wave_number": {
      "type": "integer",
      "minimum": 1,
      "description": "Wave number assignment"
    },
    "priority": {
      "type": "string",
      "enum": ["P0", "P1", "P2", "P3", "critical", "high", "medium", "low"],
      "description": "Implementation priority (P0=critical, P3=low)"
    },
    "story_points": {
      "type": "integer",
      "enum": [1, 2, 3, 5, 8, 13, 21],
      "description": "Fibonacci story point estimation"
    },
    "status": {
      "type": "string",
      "enum": ["draft", "pending", "ready", "in_progress", "blocked", "review", "complete", "completed", "cancelled"],
      "description": "Current story status"
    },
    "description": {
      "type": "string",
      "minLength": 20,
      "description": "Detailed story description explaining the work to be done"
    },

    "objective": {
      "type": "object",
      "description": "User story format: As a X, I want Y, so that Z",
      "required": ["as_a", "i_want", "so_that"],
      "properties": {
        "as_a": {
          "type": "string",
          "minLength": 3,
          "description": "User role or persona"
        },
        "i_want": {
          "type": "string",
          "minLength": 10,
          "description": "Desired action or capability"
        },
        "so_that": {
          "type": "string",
          "minLength": 10,
          "description": "Business value or outcome"
        }
      }
    },

    "acceptance_criteria": {
      "type": "array",
      "minItems": 1,
      "description": "List of acceptance criteria with optional EARS format",
      "items": {
        "type": "object",
        "required": ["id", "description"],
        "properties": {
          "id": {
            "type": "string",
            "pattern": "^AC-[0-9]{2,3}$",
            "description": "AC identifier: AC-01, AC-001, etc."
          },
          "description": {
            "type": "string",
            "minLength": 10,
            "description": "Human-readable acceptance criterion"
          },
          "ears_format": {
            "type": "string",
            "pattern": "^WHEN .+ THEN .+",
            "description": "EARS syntax: WHEN {trigger} THEN {behavior} [threshold: {metric}]"
          },
          "threshold": {
            "type": "string",
            "description": "Optional performance threshold (e.g., 'latency: <500ms')"
          },
          "test_approach": {
            "type": "string",
            "description": "How to test this criterion"
          },
          "status": {
            "type": "string",
            "enum": ["pending", "in_progress", "complete", "blocked"],
            "default": "pending"
          }
        }
      }
    },

    "files": {
      "type": "object",
      "description": "File ownership and boundaries",
      "properties": {
        "create": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Files to be created"
        },
        "modify": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Existing files to be modified"
        },
        "forbidden": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Files that MUST NOT be modified (ownership boundary)"
        },
        "existing": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Files that already exist and are referenced"
        }
      }
    },

    "technical_requirements": {
      "type": "object",
      "description": "Technical implementation details",
      "properties": {
        "reuse_components": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Existing components to reuse"
        },
        "reuse_patterns": {
          "type": "object",
          "additionalProperties": { "type": "string" },
          "description": "Design patterns to follow from existing code"
        },
        "reuse_functions": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Existing functions to reuse"
        },
        "hooks": {
          "type": "array",
          "items": { "type": "string" },
          "description": "React hooks to create or use"
        },
        "api_endpoints": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "method": { "type": "string", "enum": ["GET", "POST", "PUT", "PATCH", "DELETE"] },
              "path": { "type": "string" },
              "description": { "type": "string" }
            }
          },
          "description": "API endpoints involved"
        },
        "database_tables": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Database tables involved"
        },
        "database_changes": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Required database schema changes"
        },
        "response_format": {
          "type": "object",
          "additionalProperties": true,
          "description": "Expected API response format"
        },
        "validation": {
          "type": "string",
          "description": "Validation schema location (e.g., Zod schema path)"
        },
        "icons_from_lucide": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Lucide icons to use"
        },
        "state_management": {
          "type": "string",
          "description": "State management approach (React Query, Zustand, etc.)"
        }
      }
    },

    "design_specs": {
      "type": "object",
      "description": "UI/UX design specifications (for frontend stories)",
      "properties": {
        "layout": {
          "type": "object",
          "properties": {
            "max_width": { "type": "string" },
            "padding": { "type": "string" },
            "direction": { "type": "string", "enum": ["RTL", "LTR"] }
          }
        },
        "colors": {
          "type": "object",
          "additionalProperties": { "type": "string" }
        },
        "typography": {
          "type": "object",
          "additionalProperties": { "type": "string" }
        },
        "filter_tabs": {
          "type": "object",
          "additionalProperties": { "type": "string" }
        },
        "status_badge_variants": {
          "type": "object",
          "additionalProperties": { "type": "string" }
        },
        "empty_state": {
          "type": "object",
          "properties": {
            "icon": { "type": "string" },
            "message": { "type": "string" },
            "cta": { "type": "string" }
          }
        }
      }
    },

    "tdd": {
      "type": "object",
      "description": "Test-Driven Development configuration (V4 excellence)",
      "properties": {
        "test_framework": {
          "type": "string",
          "enum": ["vitest", "jest", "playwright"],
          "default": "vitest"
        },
        "test_files": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Test files to create"
        },
        "coverage_target": {
          "type": "number",
          "minimum": 0,
          "maximum": 100,
          "default": 80,
          "description": "Minimum coverage percentage required"
        },
        "test_categories": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["name", "count"],
            "properties": {
              "name": { "type": "string" },
              "count": { "type": "integer" },
              "examples": {
                "type": "array",
                "items": { "type": "string" }
              }
            }
          },
          "description": "Categorized test cases with examples"
        },
        "mocking_strategy": {
          "type": "object",
          "additionalProperties": { "type": "string" },
          "description": "How to mock dependencies"
        }
      }
    },

    "safety": {
      "type": "object",
      "description": "Safety guardrails and rollback procedures",
      "required": ["stop_conditions"],
      "properties": {
        "stop_conditions": {
          "type": "array",
          "items": { "type": "string" },
          "minItems": 1,
          "description": "Conditions that should immediately stop work"
        },
        "escalation_triggers": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Conditions that require human escalation"
        },
        "rollback_plan": {
          "type": "string",
          "description": "How to rollback if things go wrong"
        }
      }
    },

    "hazard_analysis": {
      "type": "object",
      "description": "DO-178C aligned hazard identification (V4.1 addition)",
      "properties": {
        "identified_hazards": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["id", "description", "severity", "mitigation"],
            "properties": {
              "id": {
                "type": "string",
                "pattern": "^HAZ-[0-9]{3}$"
              },
              "description": { "type": "string" },
              "severity": {
                "type": "string",
                "enum": ["catastrophic", "critical", "major", "minor"]
              },
              "likelihood": {
                "type": "string",
                "enum": ["frequent", "probable", "occasional", "remote", "improbable"]
              },
              "mitigation": { "type": "string" }
            }
          }
        },
        "risk_level": {
          "type": "string",
          "enum": ["high", "medium", "low"],
          "description": "Overall risk assessment"
        }
      }
    },

    "dependencies": {
      "type": "object",
      "description": "Story dependencies and blocking relationships",
      "properties": {
        "required_before": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Stories that must be complete before this one starts"
        },
        "blocks": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Stories that are blocked by this one"
        }
      }
    },

    "traceability": {
      "type": "object",
      "description": "Requirements traceability (V4.1 addition)",
      "properties": {
        "requirements": {
          "type": "array",
          "items": { "type": "string" },
          "description": "PRD or requirement IDs this story implements"
        },
        "epic": {
          "type": "string",
          "description": "Parent epic identifier"
        },
        "related_stories": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Related story IDs"
        }
      }
    },

    "gates_completed": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["gate", "completed_at"],
        "properties": {
          "gate": {
            "type": "string",
            "enum": ["gate-0", "gate-1", "gate-2", "gate-3", "gate-4", "gate-5", "gate-6", "gate-7"]
          },
          "completed_at": {
            "type": "string",
            "format": "date-time"
          },
          "approved_by": {
            "type": "string"
          },
          "evidence": {
            "type": "string",
            "description": "Link to evidence (commit, PR, report)"
          }
        }
      },
      "description": "Gate completion tracking (V4.1 addition)"
    },

    "estimated_tests": {
      "type": "integer",
      "minimum": 0,
      "description": "Estimated number of test cases"
    },
    "estimated_tokens": {
      "type": "integer",
      "minimum": 0,
      "description": "Estimated token budget for implementation"
    },
    "actual_tokens": {
      "type": "integer",
      "minimum": 0,
      "description": "Actual tokens used (filled after completion)"
    },

    "metadata": {
      "type": "object",
      "description": "Story metadata and timestamps (V4.1 addition)",
      "properties": {
        "created_at": {
          "type": "string",
          "format": "date-time"
        },
        "updated_at": {
          "type": "string",
          "format": "date-time"
        },
        "created_by": {
          "type": "string"
        },
        "completed_at": {
          "type": "string",
          "format": "date-time"
        },
        "agent_assignment": {
          "type": "string",
          "description": "Specific agent instance (e.g., fe-dev-1)"
        }
      }
    },

    "gate0_research": {
      "type": "string",
      "description": "Path to Gate 0 research document"
    },
    "notes": {
      "type": "string",
      "description": "Additional notes or context"
    }
  },

  "$defs": {
    "ears_pattern": {
      "type": "string",
      "pattern": "^WHEN .+ THEN .+",
      "description": "EARS (Easy Approach to Requirements Syntax) format"
    },
    "story_id_pattern": {
      "type": "string",
      "pattern": "^[A-Z]+-[A-Z0-9]+-?[0-9]*$"
    }
  }
}
