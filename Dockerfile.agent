# WAVE Agent Container
# Multi-stage build for efficient, secure agent execution
# Follows Docker Image Setup Guidelines

# ============================================
# Stage 1: Build dependencies
# ============================================
FROM node:20-slim AS builder

# Install build dependencies
RUN apt-get update && apt-get install -y \
    curl \
    git \
    && rm -rf /var/lib/apt/lists/*

# Install pnpm globally
RUN npm install -g pnpm

# ============================================
# Stage 2: Runtime image
# ============================================
FROM node:20-slim

LABEL maintainer="WAVE Team"
LABEL description="WAVE Agent Container - Autonomous coding agent runtime"
LABEL version="1.0.0"

# Install runtime dependencies only
RUN apt-get update && apt-get install -y --no-install-recommends \
    curl \
    git \
    jq \
    bash \
    python3 \
    python3-pip \
    && rm -rf /var/lib/apt/lists/* \
    && apt-get clean

# Create non-root user for security (Guideline 6)
# Use UID 1001 since node image already uses UID 1000
RUN useradd -m -s /bin/bash -u 1001 wave \
    && mkdir -p /home/wave/.claude \
    && chown -R wave:wave /home/wave

# Install global tools
RUN npm install -g pnpm @anthropic-ai/claude-code

# Create workspace directories (Guideline 4)
RUN mkdir -p /project /scripts /wave \
    && chown -R wave:wave /project /scripts /wave

# Copy entrypoint script
COPY --chown=wave:wave entrypoint-agent.sh /wave/entrypoint.sh
RUN chmod +x /wave/entrypoint.sh

# Switch to non-root user (Guideline 6)
USER wave

# Set working directory
WORKDIR /project

# Environment variables (Guideline 5)
ENV WAVE_HOME=/wave \
    PROJECT_PATH=/project \
    SCRIPTS_PATH=/scripts \
    NODE_ENV=production \
    PYTHONUNBUFFERED=1

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD test -f /project/.claude/gate0-lock.json || exit 1

# Default entrypoint
ENTRYPOINT ["/wave/entrypoint.sh"]

# Default command (agent type)
CMD ["idle"]
