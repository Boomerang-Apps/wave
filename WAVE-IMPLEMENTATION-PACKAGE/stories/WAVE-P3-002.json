{
  "$schema": "../../planning/schemas/story-schema-v4.2.json",
  "schema_version": "4.2",
  "story_id": "WAVE-P3-002",
  "title": "Implement Domain Boundary Enforcer",
  "type": "feature",
  "domain": "backend",
  "agent": "be-dev",
  "wave_number": 3,
  "priority": "P0",
  "story_points": 5,
  "status": "pending",
  "description": "Create a domain boundary enforcer that validates agent file access against domain ownership rules. Each domain (AUTH, CLIENT, BOOKING, PAYMENT, PILOT, ADMIN, SHARED) has defined file patterns that agents must respect. This prevents merge conflicts by ensuring agents only modify files in their domain.",

  "objective": {
    "as_a": "WAVE Orchestrator",
    "i_want": "enforcement of domain file ownership rules",
    "so_that": "agents cannot modify files outside their assigned domain, preventing conflicts"
  },

  "acceptance_criteria": [
    {
      "id": "AC-01",
      "description": "Domain ownership rules loaded from configuration",
      "ears_format": "WHEN enforcer initialized THEN domain rules loaded from wave-config.json",
      "test_approach": "Initialize enforcer, verify rules match config file",
      "status": "pending"
    },
    {
      "id": "AC-02",
      "description": "File access validated against domain rules",
      "ears_format": "WHEN agent attempts file modification THEN path checked against domain ownership",
      "test_approach": "Attempt modify file, verify validation called",
      "status": "pending"
    },
    {
      "id": "AC-03",
      "description": "Allowed modifications proceed normally",
      "ears_format": "WHEN agent modifies file in their domain THEN modification allowed",
      "test_approach": "AUTH agent modifies auth/*, verify success",
      "status": "pending"
    },
    {
      "id": "AC-04",
      "description": "Forbidden modifications blocked with error",
      "ears_format": "WHEN agent attempts to modify file outside domain THEN error thrown with explanation",
      "test_approach": "AUTH agent tries to modify booking/*, verify error",
      "status": "pending"
    },
    {
      "id": "AC-05",
      "description": "SHARED domain accessible to all agents",
      "ears_format": "WHEN any agent modifies shared/* THEN modification allowed",
      "test_approach": "Multiple agent types modify shared/*, all succeed",
      "status": "pending"
    },
    {
      "id": "AC-06",
      "description": "Violations logged for audit",
      "ears_format": "WHEN violation attempted THEN event logged with agent_id, file_path, domain",
      "test_approach": "Trigger violation, query audit log for event",
      "status": "pending"
    },
    {
      "id": "AC-07",
      "description": "Override available for emergencies with human approval",
      "ears_format": "WHEN human grants override THEN agent can temporarily access other domains",
      "test_approach": "Grant override, verify cross-domain access works",
      "status": "pending"
    }
  ],

  "files": {
    "create": [
      "orchestrator/src/domains/boundary-enforcer.ts",
      "orchestrator/src/domains/domain-rules.ts",
      "orchestrator/src/domains/types.ts",
      "orchestrator/src/domains/__tests__/boundary-enforcer.test.ts",
      "orchestrator/src/domains/__tests__/domain-rules.test.ts",
      "wave-config.json"
    ],
    "modify": [
      "orchestrator/src/agents/base-agent.ts",
      "orchestrator/src/git/worktree-manager.ts"
    ],
    "forbidden": [
      "core/safety/*"
    ]
  },

  "technical_requirements": {
    "reuse_patterns": {
      "glob_matching": "Use minimatch for file pattern matching",
      "middleware": "Enforce as middleware before file operations"
    },
    "configuration": "Domain rules in wave-config.json"
  },

  "tdd": {
    "test_framework": "vitest",
    "test_files": [
      "orchestrator/src/domains/__tests__/boundary-enforcer.test.ts",
      "orchestrator/src/domains/__tests__/domain-rules.test.ts"
    ],
    "coverage_target": 90,
    "test_categories": [
      {
        "name": "Rule Loading",
        "count": 3,
        "examples": [
          "should load rules from wave-config.json",
          "should validate rule format",
          "should handle missing config file"
        ]
      },
      {
        "name": "Access Validation",
        "count": 8,
        "examples": [
          "should allow AUTH agent to modify auth/*",
          "should deny AUTH agent from booking/*",
          "should allow any agent to modify shared/*",
          "should handle nested paths correctly",
          "should validate create operations",
          "should validate modify operations",
          "should validate delete operations",
          "should handle glob patterns"
        ]
      },
      {
        "name": "Override Handling",
        "count": 3,
        "examples": [
          "should allow override with approval",
          "should expire override after timeout",
          "should log all override usage"
        ]
      }
    ],
    "mocking_strategy": {
      "filesystem": "Mock file operations",
      "config": "Test fixture wave-config.json"
    }
  },

  "safety": {
    "stop_conditions": [
      "Domain configuration invalid or missing",
      "Repeated boundary violations from same agent",
      "Override granted without proper approval"
    ],
    "escalation_triggers": [
      "Agent repeatedly attempts forbidden access",
      "Unknown domain encountered",
      "Configuration conflicts detected"
    ],
    "rollback_plan": "Disable enforcer, revert to single-agent mode"
  },

  "dependencies": {
    "required_before": ["WAVE-P3-001"],
    "blocks": ["WAVE-P3-003", "WAVE-P4-001"]
  },

  "traceability": {
    "requirements": ["MULTI-AGENT-002", "DOMAIN-ISOLATION-001"],
    "epic": "WAVE Multi-Agent Parallel Execution",
    "related_stories": ["WAVE-P3-001", "WAVE-P3-003"]
  },

  "gates_completed": [],
  "estimated_tests": 14,
  "estimated_tokens": 25000,

  "metadata": {
    "created_at": "2026-02-07T00:00:00Z",
    "created_by": "cto-analysis",
    "agent_assignment": "be-dev-1"
  },

  "notes": "Domain boundaries are WAVE's unique differentiator. This is what prevents merge conflicts in multi-agent scenarios. The wave-config.json defines domains per project."
}
